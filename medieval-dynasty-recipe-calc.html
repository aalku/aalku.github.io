<!DOCTYPE html>
<html lang="en">

<head>
    <script lang="javascript">
        var ingredients = {
            cabagge: {
                name: "Cabbage",
                // TODO value, etc.
            },
            meat: {
                name: "Meat",
                // TODO value, etc.
            },
            woodenBowl: {
                name: "Wooden Bowl",
                // TODO value, etc.
            },
            carrot: {
                name: "Carrot",
                // TODO value, etc.
            },
        };
        var recipes = {
            potage: {
                name: "Potage",
                ingredients: {
                    cabagge: 2,
                    meat: 3,
                    woodenBowl: 1
                }
            },
            stew: {
                name: "Stew",
                ingredients: {
                    carrot: 2,
                    meat: 2,
                    woodenBowl: 1
                }
            },
        };
    </script>
    <style lang="css">
        table {
             border-collapse: collapse;
             border: 1px solid;
        }
        td {
            border: 1px solid;
            padding: 5px;
        }
        td input {
            width: 100%;
            border: none;
        }
        textarea:focus, input:focus{
            outline: none;
        }
        /* Hide spinner */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            /* display: none; <- Crashes Chrome on hover */
            -webkit-appearance: none;
            margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
        }
        input[type=number] {
            -moz-appearance:textfield; /* Firefox */
        }
        /* Align numbers to the right */
        input[type=number] {
            text-align: right;
        }
    </style>
</head>

<body>
    <h1>Medieval Dynasty Recipe Calculator</h1>
    <p>
        This calculator will help you calculate the amount of materials you need to craft a certain item.
    </p>
    <template id="recipe-template">
        <option value="id">Recipe Name</option>
    </template>
    <div id="recipe select">
        <label for="recipe">Recipe:</label>
        <select id="recipe-select" onchange="initRecipe();">
        </select>
    </div>
    <br />
    <div>
        <label for="item-count">Item count</label>
        <input id='item-count' type="number" min="1" onchange="recipeEdit(this);" onkeyup="recipeEdit(this);" placeholder="1"></input>
    </div>
    <br />
    <template id="ingredient-template">
        <tr class="ingredient">
            <td><label for="ing">Ingredient</label></td>
            <td><input type="number" min="1" onchange="recipeEdit(this);" onkeyup="recipeEdit(this);"></input></td>
        </tr>
    </template>
    <div>
        <table id="recipe-ingredients-list">
            <tr class="ingredient header">
                <th>Ingredient</th>
                <th>Quantity</th>
            </tr>
        </table>
    </div>
    <script lang="javascript">
        // Elements
        const recipeIngredientsList = document.getElementById("recipe-ingredients-list");
        const itemCount = document.getElementById("item-count");
        const recipeSelect = document.getElementById("recipe-select");

        // Templates
        const recipeIngredientsTemplate = document.getElementById("ingredient-template").content;
        const recipeTemplate = document.getElementById("recipe-template").content;

        var fixedIngredient = null;
        var fixedItemCount = false;

        function initRecipeList() {
            for (var id in recipes) {
                var option = recipeTemplate.firstElementChild.cloneNode(true);
                option.value = id;
                option.innerText = recipes[id].name;
                recipeSelect.appendChild(option);
            };
            initRecipe();
        }

        function initRecipe() {
            var recipe = document.getElementById("recipe-select").value;
            console.log("initRecipe", recipe);
            var recipeIngredients = recipes[recipe].ingredients;
            var fixedIngredientQuantity = null;

            [...recipeIngredientsList.querySelectorAll("tr")].forEach(function(row) {
                if (row.classList.contains("header")) {
                    // Keep header
                } else {
                    if (fixedIngredient && row.classList.contains("ingredient")) {
                        var input = row.querySelector("input");
                        if (input.id == "ingredient-" + fixedIngredient) {
                            // Keep fixed ingredient quantity
                            fixedIngredientQuantity = input.value;
                        }
                    }
                    row.remove();
                }
            });

            if (fixedIngredient && !recipeIngredients[fixedIngredient]) {
                fixedIngredient = null;
                fixedIngredientQuantity = null;
            }

            for (var id in recipeIngredients) {
                var ingredient = recipeIngredientsTemplate.firstElementChild.cloneNode(true);
                var input = ingredient.querySelector("input");
                input.placeholder = recipeIngredients[id];
                input.id = "ingredient-" + id;
                if (id == fixedIngredient) {
                    input.value = fixedIngredientQuantity;
                }
                ingredient.querySelector("label").innerText = ingredients[id].name;
                recipeIngredientsList.appendChild(ingredient);
            }
            recipeEdit(null);
        }

        function recipeEdit(target) {
            // console.log("recipeEdit", target, target.value, "fixed pre", fixedItemCount, fixedIngredient);

            var recipe = recipes[document.getElementById("recipe-select").value];
            var ingredientInputElements = [...recipeIngredientsList.querySelectorAll("input")].reduce(function(acc, input) {
                acc[input.id.replace("ingredient-", "")] = input;
                return acc;
            }, {});

            // Determine what is fixed and what is not
            if (fixedIngredient && ingredientInputElements[fixedIngredient].value == "") {
                fixedIngredient = null;
            }
            if (target == itemCount && target.value != "") {
                fixedItemCount = true;
                fixedIngredient = null;
            } else {
                var newFixedIngredient = Object.keys(ingredientInputElements).find(function(inputId) {
                    return ingredientInputElements[inputId] == target && target.value != "";        
                });
                if (newFixedIngredient) {
                    fixedIngredient = newFixedIngredient;
                    fixedItemCount = false;
                }
            }
            
            // Calc the rest
            // console.log("fixedPost", fixedIngredient, fixedItemCount);
            var count = null;
            if (fixedIngredient) {
                var fixedValue = ingredientInputElements[fixedIngredient].value;
                count = Number.parseInt(fixedValue / recipe.ingredients[fixedIngredient]);
            } else { // Fixed count or 1
                count = Number.parseInt(itemCount.value) || 1;
            }
            itemCount.placeholder = Number.parseInt(count) || "???";
            if (!fixedItemCount) {
                itemCount.value = "";
            }
            for (var ingredientId in recipe.ingredients) {
                var input = ingredientInputElements[ingredientId];
                input.placeholder = Number.parseInt(recipe.ingredients[ingredientId] * count) || "???";
                if (ingredientId == fixedIngredient) {
                    // No modificamos el modificado
                } else {
                    input.value = "";
                }
            }
        }
        initRecipeList();
    </script>
</body>

</html>
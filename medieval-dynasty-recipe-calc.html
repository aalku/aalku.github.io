<!DOCTYPE html>
<html lang="en">

<head>
    <template id="recipe-template">
        <option value="id">Recipe Name</option>
    </template>
    <template id="ingredient-template">
        <tr class="ingredient">
            <td><label for="ing">Ingredient</label></td>
            <td><input type="text" onchange="recipeEdit();" onkeyup="recipeEdit();"></input></td>
        </tr>
    </template>
    <script lang="javascript">
        var ingredients = {
            cabagge: {
                name: "Cabbage",
                // TODO value, etc.
            },
            meat: {
                name: "Meat",
                // TODO value, etc.
            },
            woodenBowl: {
                name: "Wooden Bowl",
                // TODO value, etc.
            },
        };
        var recipes = {
            potage: {
                name: "Potage",
                ingredients: {
                    cabagge: 2,
                    meat: 3,
                    woodenBowl: 1
                }
            }
        };
    </script>
    <style lang="css">
        table {
             border-collapse: collapse;
             border: 1px solid;
        }
        td {
            border: 1px solid;
            padding: 5px;
        }
        td input {
            width: 100%;
            border: none;
        }
        textarea:focus, input:focus{
            outline: none;
        }
    </style>
</head>

<body>
    <h1>Medieval Dynasty Recipe Calculator</h1>
    <p>
        This calculator will help you calculate the amount of materials you need to craft a certain item.
    </p>
    <div id="recipe select">
        <label for="recipe">Recipe:</label>
        <select id="recipe-select" onchange="initRecipe">
        </select>
    </div>
    <br />
    <div>
        <label for="item-count">Item count</label>
        <input id='item-count' type="text" onchange="recipeEdit();" onkeyup="recipeEdit();"></input>
    </div>
    <br />
    <div>
        <table id="recipe-ingredients-list">
            <tr class="ingredient header">
                <th>Ingredient</th>
                <th>Quantity</th>
            </tr>
        </table>
    </div>
    <script lang="javascript">
        // Elements
        const recipeIngredientsList = document.getElementById("recipe-ingredients-list");
        const itemCount = document.getElementById("item-count");
        const recipeSelect = document.getElementById("recipe-select");

        // Templates
        const recipeIngredientsTemplate = document.getElementById("ingredient-template").content;
        const recipeTemplate = document.getElementById("recipe-template").content;

        function initRecipeList() {
            for (var id in recipes) {
                var option = recipeTemplate.firstElementChild.cloneNode(true);
                option.value = id;
                option.innerText = recipes[id].name;
                recipeSelect.appendChild(option);
            };
            initRecipe();
        }
        function initRecipe() {
            var recipe = document.getElementById("recipe-select").value;
            console.log("initRecipe", recipe);
            var recipeIngredients = recipes[recipe].ingredients;
            itemCount.value = "";
            itemCount.placeholder = "1";

            for (var id in recipeIngredients) {
                var ingredient = recipeIngredientsTemplate.firstElementChild.cloneNode(true);
                var input = ingredient.querySelector("input");
                input.placeholder = recipeIngredients[id];
                input.id = "ingredient-" + id;
                ingredient.querySelector("label").innerText = ingredients[id].name;
                recipeIngredientsList.appendChild(ingredient);
            }
        }
        function recipeEdit(event) {
            var recipe = recipes[document.getElementById("recipe-select").value];
            var ingredientInputElements = [...recipeIngredientsList.querySelectorAll("input")].reduce(function(acc, input) {
                acc[input.id.replace("ingredient-", "")] = input;
                return acc;
            }, {});
            /** Fixed ingredient or null if count is fixed */
            var fixedIngredient = Number.parseInt(itemCount.value) ? null : Object.keys(ingredientInputElements).find(function(inputId) {
                return ingredientInputElements[inputId].value != "";
            });
            var count = null;
            if (fixedIngredient) {
                var fixedValue = ingredientInputElements[fixedIngredient].value;
                count = Number.parseInt(fixedValue / recipe.ingredients[fixedIngredient]);
                console.log("fixedIngredient", fixedIngredient, fixedValue, recipe.ingredients[fixedIngredient], count);
            } else { // Fixed count or 1
                count = Number.parseInt(itemCount.value) || 1;
            }
            itemCount.placeholder = count;
            for (var ingredientId in recipe.ingredients) {
                var input = ingredientInputElements[ingredientId];
                input.placeholder = recipe.ingredients[ingredientId] * count;
                if (input.value != "" && input.value != input.placeholder) {
                    if (ingredientId == fixedIngredient) {
                        // No modificamos el que marca todo
                    } else {
                        input.value = "";
                    }
                }
            }
        }
        initRecipeList();
    </script>
</body>

</html>
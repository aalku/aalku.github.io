<!DOCTYPE html>
<html lang="en">

<head>
    <script lang="javascript">

        const buyPriceMultiplier = 1.5;
        const sellPriceMultiplier = 0.5;

        const gameItems = {
            /* basic */
            meat: {
                name: "Meat",
                price: 3.00,
            },
            "fish-meat": {
                name: "Fish Meat",
                price: 4.00,
            },
            "bolete-mushroom": {
                name: "Bolete Mushroom",
                price: 3.00,
            },
            "parsol-mushroom": {
                name: "Parsol Mushroom",
                price: 3.00,
            },
            "red-pine-mushroom": {
                name: "Red Pine Mushroom",
                price: 3.00,
            },
            "morel-mushroom": {
                name: "Morel Mushroom",
                price: 2.00,
            },
            "bitter-bolete-mushroom": {
                name: "Bitter Bolete Mushroom",
                price: 2.00,
            },
            "fly-agaric-mushroom": {
                name: "Fly Agaric Mushroom",
                price: 2.00,
            },
            "wooly-milkcap-mushroom": {
                name: "Wooly Milkcap Mushroom",
                price: 2.00,
            },
            "berry": {
                name: "Berry",
                price: 0.20,
            },
            /* farm */
            egg: {
                name: "Egg",
                price: 10.00,
            },
            betroot: {
                name: "Betroot",
                price: 3.00,
            },
            cabagge: {
                name: "Cabbage",
                price: 3.00,
            },
            apple: {
                name: "Apple",
                price: 3.00,
            },
            pear: {
                name: "Pear",
                price: 3.00,
            },
            carrot: {
                name: "Carrot",
                price: 2.00,
            },
            onion: {
                name: "Onion",
                price: 2.00,
            },
            cherry: {
                name: "Cherry",
                price: 2.00,
            },
            plum: {
                name: "Plum",
                price: 2.00,
            },
            /* Roasted */
            "roasted-meat": {
                name: "Roasted Meat",
                price: 5.00,
                base: "meat",
                productionMultiplier: 1,
            },
            "roasted-fish": {
                name: "Roasted Fish",
                price: 6.00,
                base: "fish-meat",
                productionMultiplier: 1,
            },
            /* Cooked */
            potage: {
                name: "Potage",
                price: 50.00,
                recipe: true,
            },
            stew: {
                name: "Stew",
                price: 40.00,
                recipe: true,
            },
            "meat-with-gravy": {
                name: "Meat with Gravy",
                price: 40.00,
                recipe: true,
            },
            soup: {
                name: "Soup",
                price: 50.00,
                recipe: true,
            },
            /* containers */
            woodenBowl: {
                name: "Wooden Bowl",
                base: "log",
                productionMultiplier: 5,
            },
            woodenPlate: {
                name: "Wooden Plate",
                base: "log",
                productionMultiplier: 5,
            },
            /* Raw materials */
            log: {
                name: "Log",
                price: 5.00,
            },
        };
        const recipes = {
            potage: {
                ingredients: {
                    cabagge: 2,
                    meat: 3,
                    woodenBowl: 1
                }
            },
            stew: {
                ingredients: {
                    carrot: 2,
                    meat: 2,
                    woodenBowl: 1
                }
            },
            "meat-with-gravy": {
                ingredients: {
                    onion: 3,
                    "roasted-meat": 2,
                    woodenPlate: 1
                }
            },
            soup: {
                ingredients: {
                    betroot: 3,
                    meat: 4,
                    woodenBowl: 1
                }
            },
        };
    </script>
    <style lang="css">
        table {
             border-collapse: collapse;
             border: 1px solid;
        }
        td {
            border: 1px solid;
            padding: 5px;
        }
        td input, td select {
            width: 100%;
            border: none;
        }
        textarea:focus, input:focus, select:focus {
            outline: none;
        }
        /* Hide spinner */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            /* display: none; <- Crashes Chrome on hover */
            -webkit-appearance: none;
            margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
        }
        input[type=number] {
            -moz-appearance:textfield; /* Firefox */
        }
        /* Align numbers to the right */
        td.number span, td.number input {
            text-align: right;
        }
        /* */
        td.number span, td.number input {
            display: block;
            width: 12em;
            font-family: Arial;
            font-size: 14px;
            padding: 0px;
        }
        td label {
            display: block;
            width: 15em;
        }
        </style>
</head>

<body>
    <h1>Medieval Dynasty Recipe Calculator</h1>
    <p>
        This calculator will help you calculate the amount of materials you need to craft a certain item.
    </p>
    <div>
        <table id="recipe-input-information">
            <thead>
                <tr><th colspan="2">Recipe input information</tr></tr>
            </thead>
            <template id="recipe-template">
                <option value="id">Recipe Name</option>
            </template>
            <tr class="data">
                <td><label for="recipe">Recipe name</label></td>
                <td><select id="recipe-select" onchange="initRecipe();"></select></td>
            </tr>
            <tr class="data">
                <td><label for="item-count">Item count</label></td>
                <td class="number"><input id='item-count' type="number" min="1" onchange="recipeEdit(this);" onkeyup="recipeEdit(this);" placeholder="1"></input></td>
            </tr>
        </table>
    </div>
    <br />
    <div>
        <table id="recipe-ingredients-list">
            <tr class="ingredient header">
                <th>Ingredient</th>
                <th>Quantity</th>
            </tr>
            <template id="ingredient-template">
                <tr class="ingredient-row">
                    <td><label for="ing">Ingredient</label></td>
                    <td class="number"><input type="number" min="1" onchange="recipeEdit(this);" onkeyup="recipeEdit(this);"></input></td>
                </tr>
            </template>
        </table>
    </div>
    <br />
    <div>
        <table id="recipe-information">
            <thead>
                <tr><th colspan="2">Production information</tr></tr>
            </thead>
            <tr>
                <td><label for="base-price">Base price</label></td>
                <td class="number"><span id="base-price"></span></td>
            </tr>
            <tr>
                <td><label for="sell-price">Sell price</label></td>
                <td class="number"><span id="sell-price"></span></td>
            </tr>
            <tr>
                <td><label for="ingredients-base-price">Ingredients base price</label></td>
                <td class="number"><span id="ingredients-base-price"></span></td>
            </tr>
            <tr>
                <td><label for="ingredients-sell-price">Ingredients sell price</label></td>
                <td class="number"><span id="ingredients-sell-price"></span></td>
            </tr>
        </table>
    </div>
    <script lang="javascript">
        // Elements
        const recipeIngredientsList = document.getElementById("recipe-ingredients-list");
        const itemCount = document.getElementById("item-count");
        const recipeSelect = document.getElementById("recipe-select");

        // Templates
        const recipeIngredientsTemplate = document.getElementById("ingredient-template").content;
        const recipeTemplate = document.getElementById("recipe-template").content;

        var fixedIngredient = null;
        var fixedItemCount = false;

        function initRecipeList() {
            for (var id in recipes) {
                var option = recipeTemplate.firstElementChild.cloneNode(true);
                option.value = id;
                option.innerText = gameItems[id].name;
                recipeSelect.appendChild(option);
            };
            initRecipe();
        }

        function initRecipe() {
            var recipe = document.getElementById("recipe-select").value;
            console.log("initRecipe", recipe);
            var recipeIngredients = recipes[recipe].ingredients;
            var fixedIngredientQuantity = null;

            [...recipeIngredientsList.querySelectorAll("tr")].forEach(function(row) {
                if (row.classList.contains("header")) {
                    // Keep header
                } else {
                    if (fixedIngredient && row.classList.contains("ingredient-row")) {
                        var input = row.querySelector("input");
                        if (input.id == "ingredient-" + fixedIngredient) {
                            // Keep fixed ingredient quantity
                            fixedIngredientQuantity = input.value;
                        }
                    }
                    row.remove();
                }
            });

            if (fixedIngredient && !recipeIngredients[fixedIngredient]) {
                fixedIngredient = null;
                fixedIngredientQuantity = null;
            }

            for (var id in recipeIngredients) {
                var ingredient = recipeIngredientsTemplate.firstElementChild.cloneNode(true);
                var input = ingredient.querySelector("input");
                input.placeholder = recipeIngredients[id];
                input.id = "ingredient-" + id;
                if (id == fixedIngredient) {
                    input.value = fixedIngredientQuantity;
                }
                ingredient.querySelector("label").innerText = gameItems[id].name;
                recipeIngredientsList.appendChild(ingredient);
            }
            recipeEdit(null);
        }

        function recipeEdit(target) {
            // console.log("recipeEdit", target, target.value, "fixed pre", fixedItemCount, fixedIngredient);
            var recipeId = document.getElementById("recipe-select").value;
            var recipe = recipes[recipeId];
            var ingredientInputElements = [...recipeIngredientsList.querySelectorAll("input")].reduce(function(acc, input) {
                acc[input.id.replace("ingredient-", "")] = input;
                return acc;
            }, {});

            // Determine what is fixed and what is not
            if (fixedIngredient && ingredientInputElements[fixedIngredient].value == "") {
                fixedIngredient = null;
            }
            if (target == itemCount && target.value != "") {
                fixedItemCount = true;
                fixedIngredient = null;
            } else {
                var newFixedIngredient = Object.keys(ingredientInputElements).find(function(inputId) {
                    return ingredientInputElements[inputId] == target && target.value != "";        
                });
                if (newFixedIngredient) {
                    fixedIngredient = newFixedIngredient;
                    fixedItemCount = false;
                }
            }
            
            // Calc the rest
            // console.log("fixedPost", fixedIngredient, fixedItemCount);
            var count = null;
            if (fixedIngredient) {
                var fixedValue = ingredientInputElements[fixedIngredient].value;
                count = Number.parseInt(fixedValue / recipe.ingredients[fixedIngredient]);
            } else { // Fixed count or 1
                count = Number.parseInt(itemCount.value) || 1;
            }
            itemCount.placeholder = Number.parseInt(count) || "???";
            if (!fixedItemCount) {
                itemCount.value = "";
            }
            var ingredientsBasePrice = 0;
            for (var ingredientId in recipe.ingredients) {
                var input = ingredientInputElements[ingredientId];
                console.debug("recipeEdit.calc.input", ingredientId, input.value);
                var q = Number.parseInt(recipe.ingredients[ingredientId]);
                ingredientsBasePrice += q * (gameItems[ingredientId].price || 0);
                input.placeholder = `${q} x ${count} = ${ count * q  || '???'}`;
                if (ingredientId == fixedIngredient) {
                    // No modificamos el modificado
                } else {
                    input.value = "";
                }
            }

            // Calc and fill the details
            var recipeBasePrice = Number.parseInt(gameItems[recipeId].price);
            document.getElementById("base-price").innerText = `${recipeBasePrice} x ${count} = ${ count * recipeBasePrice * 1  || '???'}`;
            document.getElementById("sell-price").innerText = `${recipeBasePrice} x ${sellPriceMultiplier} x ${count} = ${ count * recipeBasePrice * sellPriceMultiplier || '???' }`;
            document.getElementById("ingredients-base-price").innerText = `${ingredientsBasePrice} x ${count} = ${ count * ingredientsBasePrice * 1  || '???'}`;
            document.getElementById("ingredients-sell-price").innerText = `${ingredientsBasePrice} x ${count} x ${sellPriceMultiplier} = ${ count * ingredientsBasePrice * sellPriceMultiplier  || '???'}`;
        }
        initRecipeList();
    </script>
</body>

</html>